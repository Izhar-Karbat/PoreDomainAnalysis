<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ run_name }} - Printable MD Analysis Report</title>
    <style>
        /* --- Base Styles --- */
        body {
            font-family: "Liberation Sans", Arial, Helvetica, sans-serif; /* Common sans-serif */
            line-height: 1.5;
            margin: 0;
            color: #333;
            background-color: white;
            font-size: 10pt; /* Reset base font size */
        }
        .container {
            max-width: 100%;
            margin: 0;
            background: white;
            padding: 0;
        }
        h1 { text-align: center; border-bottom: 2px solid #0056b3; margin: 10px 0 10px 0; padding-bottom: 5px; font-size: 1.6em; }
        h2 { /* Section Headers */
            border-bottom: 2px solid #0056b3;
            margin-top: 20px; /* Space above section */
            margin-bottom: 10px; /* Space below section header */
            padding-left: 5mm; /* Indent like content */
            font-size: 1.4em;
            color: #0056b3;
        }
        h3 { /* Subsection Headers */
            border-bottom: 1px solid #ddd;
            margin-top: 18px; /* Space above subsection */
            margin-bottom: 8px; /* Space below subsection header */
            font-size: 1.2em;
            color: #004085; /* Slightly darker blue */
        }
        .section-content {
             padding-left: 5mm;
             padding-right: 5mm;
             margin-bottom: 10px;
        }
        .subsection { /* Wrapper for h3 + content */
            margin-bottom: 15px; /* Space below a subsection block */
        }
        .plot-container {
            margin: 10px 0 15px 0; /* Top, R/L, Bottom */
            text-align: center;
        }
        .plot-container img {
            max-width: 98%; /* Slightly less than full width */
            height: auto;
            border: 1px solid #ddd;
            padding: 3px;
            background: #fff;
            margin-bottom: 3px;
        }
        .plot-caption {
            font-style: italic;
            font-size: 0.85em;
            text-align: center;
            margin-top: 2px;
            color: #555;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0 15px 0; /* Reduced top margin, keep bottom */
            font-size: 0.85em; /* Slightly larger table font */
        }
        .stats-table th, .stats-table td {
            padding: 6px 8px; /* Slightly more padding */
            border: 1px solid #ccc; /* Lighter border */
            text-align: left;
            vertical-align: top; /* Align content top */
        }
        .stats-table th {
            background-color: #e9ecef;
            font-weight: bold;
            color: #495057;
        }
        .stats-table tr:nth-child(even) { background-color: #f8f9fa; }

        /* Info boxes etc. */
        .info-box, .warning-box, .error-box, .control-system-banner {
             padding: 10px; margin: 10px 0; font-size: 0.9em; border-radius: 4px;
        }
        .info-box { background-color: #e7f1ff; border-left: 4px solid #0056b3;}
        .warning-box { background-color: #fff3cd; border-left: 4px solid #ffc107;}
        .error-box { background-color: #f8d7da; border-left: 4px solid #dc3545;}
        .control-system-banner { background-color: #17a2b8; color: white; text-align: center; font-weight: bold; font-size: 1.0em; }

        .toc { /* Table of Contents Styling */
            background-color: #f8f9fa;
            padding: 10px 15px;
            margin: 10px 5mm 20px 5mm; /* Match content indent */
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .toc h2 { margin-top: 5px; margin-bottom: 10px; font-size: 1.3em; border-bottom: 1px solid #ccc; }
        .toc ul { list-style-type: none; padding-left: 10px; margin: 5px 0;}
        .toc li { margin-bottom: 5px; font-size: 0.95em; }
        .toc a { text-decoration: none; color: #0056b3; }
        .toc a:hover { text-decoration: underline; }

        .unavailable { font-style: italic; color: #6c757d; padding: 10px; text-align: center; }
        .footer { text-align: center; margin: 20px 0 10px 0; font-size: 0.8em; color: #666; }


        /* --- Print-Specific Styles --- */
        @media print {
            @page {
                size: A4 portrait;
                margin: 15mm; /* Standard A4 margins */
            }
            html, body {
                width: 100%;
                font-size: 9.5pt; /* Slightly smaller for print density */
                margin: 0;
                padding: 0;
                background-color: white; /* Ensure white background */
                orphans: 3;
                widows: 3;
            }
            .container { margin: 0; padding: 0; border: none; box-shadow: none; }
            a { text-decoration: none; color: #000; } /* Black links for print */

            /* --- Page Break Control --- */
            /* --- Pagination helpers --- */
            /* Start each major <div class="page-break" …> on a fresh sheet */
            .page-break { page-break-before: always !important; margin: 0; }
            /* Glue a heading + its first element so they never split */
            .keep-with-next { page-break-after: avoid; break-after: avoid-page; }

            /* Half-height plot container for auxiliary graphics (e.g. KDE) */
            .half-height img { max-height: 100mm; }
            
            /* keep colours when the browser prints to PDF or paper */
            * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            
             /* Prevent breaks right after headers */
            h2, h3 {
                 page-break-after: avoid !important;
            }
             /* Try hard to keep these blocks together */
            .subsection, .plot-container, table.stats-table, .toc, .info-box, .warning-box, .error-box {
                page-break-inside: avoid !important;
            }
            /* Also specifically target tables again for emphasis */
             table.stats-table, thead, tbody, tr {
                 page-break-inside: avoid !important;
            }

             /* Avoid breaking before subsections if possible, but don't force page */
            .subsection, h3 {
                 page-break-before: avoid;
            }
             /* Default break behavior after plots */
            .plot-container {
                 page-break-after: auto;
            }

            /* Image constraints */
            .plot-container img {
                 max-width: 100%; /* Ensure image fits width */
                 max-height: 260mm;   /* 297 mm page − 2 × 15 mm margin */
                 height: auto;
                 page-break-inside: avoid; /* Redundant but safe */
            }

            /* Table Font Size (Optional: Uncomment if tables still break) */
            /*
            .stats-table { font-size: 0.8em; }
            .stats-table th, .stats-table td { padding: 4px 6px; }
            */

            /* Footer handling */
            .footer { display: none; } /* Hide HTML footer if PDF tool adds its own */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MD Analysis Report</h1>
        <div style="text-align: center; font-size: 0.9em; margin-bottom: 15px;">
             Generated: {{ generation_date }} | Analysis Version: {{ analysis_version }}
             {% if is_control_system %} | <span style="color: #17a2b8; font-weight: bold;">CONTROL SYSTEM</span> {% endif %}
        </div>

        <div class="toc">
            <h2>Table of Contents</h2>
            <ul>
                <li><a href="#overview">1. Overview & Distances</a></li>
                {% if not is_control_system %}<li><a href="#toxin">2. Toxin Interface</a></li>{% endif %}
                <li><a href="#pore-ions">{% if is_control_system %}2{% else %}3{% endif %}. Pore Ions</a></li>
                <li><a href="#inner-vestibule">{% if is_control_system %}3{% else %}4{% endif %}. Inner Vestibule</a></li>
                <li><a href="#carbonyl">{% if is_control_system %}4{% else %}5{% endif %}. Carbonyl Dynamics</a></li>
                <li><a href="#tyrosine">{% if is_control_system %}5{% else %}6{% endif %}. SF Tyrosine</a></li>
                <li><a href="#dw-gate">{% if is_control_system %}6{% else %}7{% endif %}. DW Gate</a></li>
                <li><a href="#pocket">{% if is_control_system %}7{% else %}8{% endif %}. Pocket Waters</a></li>
            </ul>
        </div>

        <div class="page-break" id="overview">
            <h2>1. Overview & Distances</h2>
            <div class="section-content">
                <div class="subsection"> <h3>Run Information</h3>
                    <table class="stats-table">
                         <tr><th>System</th><td>{{ metadata.get('system_name', run_dir.split('/')[-2] if run_dir else 'N/A') }}</td></tr>
                         <tr><th>Run</th><td>{{ run_name }}</td></tr>
                         <tr><th>Path</th><td>{{ run_dir }}</td></tr>
                         <tr><th>System Type</th><td>{% if is_control_system %}Control (No Toxin){% else %}Toxin-Channel Complex{% endif %}</td></tr>
                         <tr><th>Analysis Timestamp</th><td>{{ generation_date }}</td></tr>
                         <tr><th>Analysis Version</th><td>{{ analysis_version }}</td></tr>
                    </table>
                </div>

                <div class="subsection"> <h3>G-G Distance Analysis</h3>
                    <table class="stats-table">
                        <thead><tr><th>Metric</th><th>Filtered A:C</th><th>Filtered B:D</th></tr></thead>
                        <tbody>
                        <tr><td>Mean (Å)</td><td>{{ metrics.get('G_G_AC_Mean_Filt', {}).get('value') | default('N/A', true) | replace('N/A', None) | float | round(3) if metrics.get('G_G_AC_Mean_Filt', {}).get('value') is not none else 'N/A' }}</td><td>{{ metrics.get('G_G_BD_Mean_Filt', {}).get('value') | default('N/A', true) | replace('N/A', None) | float | round(3) if metrics.get('G_G_BD_Mean_Filt', {}).get('value') is not none else 'N/A' }}</td></tr>
                        <tr><td>Std Dev (Å)</td><td>{{ metrics.get('G_G_AC_Std_Filt', {}).get('value') | default('N/A', true) | replace('N/A', None) | float | round(3) if metrics.get('G_G_AC_Std_Filt', {}).get('value') is not none else 'N/A' }}</td><td>{{ metrics.get('G_G_BD_Std_Filt', {}).get('value') | default('N/A', true) | replace('N/A', None) | float | round(3) if metrics.get('G_G_BD_Std_Filt', {}).get('value') is not none else 'N/A' }}</td></tr>
                        <tr><td>Min (Å)</td><td>{{ metrics.get('G_G_AC_Min_Filt', {}).get('value') | default('N/A', true) | replace('N/A', None) | float | round(3) if metrics.get('G_G_AC_Min_Filt', {}).get('value') is not none else 'N/A' }}</td><td>{{ metrics.get('G_G_BD_Min_Filt', {}).get('value') | default('N/A', true) | replace('N/A', None) | float | round(3) if metrics.get('G_G_BD_Min_Filt', {}).get('value') is not none else 'N/A' }}</td></tr>
                        <tr><td>Max (Å)</td><td>{{ metrics.get('G_G_AC_Max_Filt', {}).get('value') | default('N/A', true) | replace('N/A', None) | float | round(3) if metrics.get('G_G_AC_Max_Filt', {}).get('value') is not none else 'N/A' }}</td><td>{{ metrics.get('G_G_BD_Max_Filt', {}).get('value') | default('N/A', true) | replace('N/A', None) | float | round(3) if metrics.get('G_G_BD_Max_Filt', {}).get('value') is not none else 'N/A' }}</td></tr>
                        </tbody>
                    </table>
                    <div class="plot-container">
                        {% if plots.get('subunit_comparison') %}
                            <img src="data:image/png;base64,{{ plots.subunit_comparison }}" alt="G-G Distance Subunit Comparison">
                            <p class="plot-caption">G-G Distance comparison between subunits showing raw and filtered data</p>
                        {% else %}
                            <p class="unavailable"><i>G-G distance comparison plot not available.</i></p>
                        {% endif %}
                    </div>
                </div>

                {% if not is_control_system %}
                <div class="page-break"></div>
                <!-- force this subsection to begin on a new sheet -->
                <div class="subsection page-break">
                  <div class="keep-with-next">
                    <h3>COM Distance Analysis (Toxin-Channel Stability)</h3>
                    <!-- stats table stays glued to the heading -->
                    <table class="stats-table">
                        <thead><tr><th>Metric</th><th>Filtered COM</th></tr></thead>
                        <tbody>
                         <tr><td>Mean (Å)</td><td>{{ metrics.get('COM_Mean_Filt', {}).get('value') | default('N/A', true) | replace('N/A', None) | float | round(3) if metrics.get('COM_Mean_Filt', {}).get('value') is not none else 'N/A' }}</td></tr>
                         <tr><td>Std Dev (Å)</td><td>{{ metrics.get('COM_Std_Filt', {}).get('value') | default('N/A', true) | replace('N/A', None) | float | round(3) if metrics.get('COM_Std_Filt', {}).get('value') is not none else 'N/A' }}</td></tr>
                         <tr><td>Min (Å)</td><td>{{ metrics.get('COM_Min_Filt', {}).get('value') | default('N/A', true) | replace('N/A', None) | float | round(3) if metrics.get('COM_Min_Filt', {}).get('value') is not none else 'N/A' }}</td></tr>
                         <tr><td>Max (Å)</td><td>{{ metrics.get('COM_Max_Filt', {}).get('value') | default('N/A', true) | replace('N/A', None) | float | round(3) if metrics.get('COM_Max_Filt', {}).get('value') is not none else 'N/A' }}</td></tr>
                        </tbody>
                    </table>
                  </div>  <!-- end keep-with-next -->

                    <div class="plot-container">
                        {% if plots.get('comparison') %}
                            <img src="data:image/png;base64,{{ plots.comparison }}" alt="COM Distance Filtering Comparison">
                            <p class="plot-caption">COM Distance between toxin and channel, showing both raw and filtered data</p>
                        {% else %}
                            <p class="unavailable"><i>COM distance plot not available.</i></p>
                        {% endif %}
                    </div>
                     <div class="plot-container half-height">
                        {% if plots.get('com_kde') %}
                            <img src="data:image/png;base64,{{ plots.com_kde }}" alt="COM KDE Analysis">
                            <p class="plot-caption">Kernel Density Estimation analysis of COM distances</p>
                        {% else %}
                            <p class="unavailable"><i>COM KDE plot not available.</i></p>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="subsection">
                    <h3>COM Distance Analysis</h3>
                    <div class="info-box">
                        This is a control system without toxin. COM distance analysis is not applicable.
                    </div>
                </div>
                {% endif %}
            </div> </div> {% if not is_control_system %}
        <div class="page-break" id="toxin">
            <h2>2. Toxin Interface</h2>
            <div class="section-content">
                <div class="subsection">
                    <h3>Toxin Orientation</h3>
                    <div class="plot-container">
                         {% if plots.get('orientation_angle') %}
                             <img src="data:image/png;base64,{{ plots.orientation_angle }}" alt="Toxin Orientation Plot">
                             <p class="plot-caption">Time series of Toxin Orientation Angles</p>
                         {% else %}
                             <p class="unavailable"><i>Toxin orientation plot not available.</i></p>
                         {% endif %}
                    </div>
                </div>
                 <div class="subsection">
                    <h3>Contact Analysis</h3>
                    <div class="plot-container">
                         {% if plots.get('contact_map_focused') %}
                             <img src="data:image/png;base64,{{ plots.contact_map_focused }}" alt="Contact Heatmap">
                             <p class="plot-caption">Heatmap of contact frequency between toxin and channel residues</p>
                         {% else %}
                             <p class="unavailable"><i>Contact heatmap not available.</i></p>
                         {% endif %}
                    </div>

                    <!-- Added summary metrics table -->
                    <table class="stats-table">
                        <thead><tr><th>Metric</th><th>Value</th><th>Units</th></tr></thead>
                        <tbody>
                          <tr><td>Mean Atom Contacts</td>
                              <td>{{ metrics.get('Orient_Contacts_Mean', {}).get('value', 'N/A') }}</td>
                              <td>count</td></tr>
                          <tr><td>Std Dev Atom Contacts</td>
                              <td>{{ metrics.get('Orient_Contacts_Std', {}).get('value', 'N/A') }}</td>
                              <td>count</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Force new sheet for Pore-Ions module -->
        <div class="page-break" id="pore-ions">
             <h2>{% if is_control_system %}2{% else %}3{% endif %}. Pore Ions</h2>
             <div class="section-content">
                 <div class="subsection">
                    <h3>Ion Occupancy</h3>
                    <div class="plot-container">
                        {% if plots.get('k_ion_occupancy_heatmap') %}
                            <img src="data:image/png;base64,{{ plots.k_ion_occupancy_heatmap }}" alt="Ion Occupancy Heatmap">
                            <p class="plot-caption">Ion occupancy heatmap in the selectivity filter sites</p>
                        {% else %}
                            <p class="unavailable"><i>Ion occupancy heatmap not available.</i></p>
                        {% endif %}
                    </div>
                </div>
                 <div class="subsection">
                    <h3>Ion Conduction</h3>
                    <div class="plot-container">
                        {% if plots.get('k_ion_combined_plot') %}
                            <img src="data:image/png;base64,{{ plots.k_ion_combined_plot }}" alt="Ion Conduction Plot">
                            <p class="plot-caption">Ion Z-position time series and density distribution</p>
                        {% else %}
                            <p class="unavailable"><i>Ion conduction/density plot not available.</i></p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="page-break" id="inner-vestibule">
            <h2>{% if is_control_system %}3{% else %}4{% endif %}. Inner Vestibule</h2>
            <div class="section-content">
                 <div class="subsection">
                    <h3>Water Occupancy</h3>
                    <div class="plot-container">
                        {% if plots.get('inner_vestibule_count_plot') %}
                            <img src="data:image/png;base64,{{ plots.inner_vestibule_count_plot }}" alt="Water Occupancy Plot">
                            <p class="plot-caption">Water occupancy in the inner vestibule</p>
                        {% else %}
                            <p class="unavailable"><i>Water occupancy plot not available.</i></p>
                        {% endif %}
                    </div>
                </div>
                 <div class="subsection">
                    <h3>Water Residence Time</h3>
                    <div class="plot-container">
                        {% if plots.get('inner_vestibule_residence_hist') %}
                            <img src="data:image/png;base64,{{ plots.inner_vestibule_residence_hist }}" alt="Water Residence Histogram">
                            <p class="plot-caption">Histogram of water residence times in the inner vestibule</p>
                        {% else %}
                            <p class="unavailable"><i>Water residence histogram not available.</i></p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="page-break" id="carbonyl">
             <h2>{% if is_control_system %}4{% else %}5{% endif %}. Carbonyl Dynamics</h2>
             <div class="section-content">
                 <div class="subsection">
                    <h3>Gyration Analysis</h3>
                    <div class="plot-container">
                        {% if plots.get('g1_gyration_radii') %}
                            <img src="data:image/png;base64,{{ plots.g1_gyration_radii }}" alt="G1 Gyration Analysis">
                            <p class="plot-caption">G1 gyration radii in the selectivity filter</p>
                        {% else %}
                            <p class="unavailable"><i>G1 gyration analysis plot not available.</i></p>
                        {% endif %}
                    </div>
                    <div class="plot-container">
                        {% if plots.get('y_gyration_radii') %}
                            <img src="data:image/png;base64,{{ plots.y_gyration_radii }}" alt="Y Gyration Analysis">
                            <p class="plot-caption">Y gyration radii in the selectivity filter</p>
                        {% else %}
                            <p class="unavailable"><i>Y gyration analysis plot not available.</i></p>
                        {% endif %}
                    </div>
                 </div>
                 <div class="subsection">
                     <h3>Carbonyl Flip Duration</h3> <div class="plot-container">
                        {% if plots.get('flip_duration_distribution') %}
                            <img src="data:image/png;base64,{{ plots.flip_duration_distribution }}" alt="Flip Duration Distribution">
                            <p class="plot-caption">Distribution of carbonyl flip durations</p>
                        {% else %}
                            <p class="unavailable"><i>Flip duration distribution plot not available.</i></p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="page-break" id="tyrosine">
             <h2>{% if is_control_system %}5{% else %}6{% endif %}. SF Tyrosine</h2>
             <div class="section-content">
                 <div class="subsection">
                    <h3>Tyrosine Rotamer Analysis</h3>
                    <div class="plot-container">
                        {% if plots.get('sf_tyrosine_chi1_dihedrals') %}
                            <img src="data:image/png;base64,{{ plots.sf_tyrosine_chi1_dihedrals }}" alt="Tyrosine Chi1 Dihedrals">
                            <p class="plot-caption">SF Tyrosine Chi1 Dihedral Time Series</p>
                        {% else %}
                            <p class="unavailable"><i>Tyrosine Chi1 dihedral plot not available.</i></p>
                        {% endif %}
                    </div>
                    <div class="plot-container">
                        {% if plots.get('sf_tyrosine_chi2_dihedrals') %}
                            <img src="data:image/png;base64,{{ plots.sf_tyrosine_chi2_dihedrals }}" alt="Tyrosine Chi2 Dihedrals">
                            <p class="plot-caption">SF Tyrosine Chi2 Dihedral Time Series</p>
                        {% else %}
                            <p class="unavailable"><i>Tyrosine Chi2 dihedral plot not available.</i></p>
                        {% endif %}
                    </div>
                    <div class="plot-container">
                        {% if plots.get('sf_tyrosine_rotamer_scatter') %}
                            <img src="data:image/png;base64,{{ plots.sf_tyrosine_rotamer_scatter }}" alt="Tyrosine Rotamer Scatter">
                            <p class="plot-caption">Scatter plot of tyrosine rotamer conformations</p>
                        {% else %}
                            <p class="unavailable"><i>Tyrosine rotamer scatter plot not available.</i></p>
                        {% endif %}
                    </div>
                    <div class="plot-container">
                        {% if plots.get('sf_tyrosine_rotamer_population') %}
                            <img src="data:image/png;base64,{{ plots.sf_tyrosine_rotamer_population }}" alt="Tyrosine Rotamer Population">
                            <p class="plot-caption">Population analysis of tyrosine rotamer states</p>
                        {% else %}
                            <p class="unavailable"><i>Tyrosine rotamer population plot not available.</i></p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="page-break" id="dw-gate">
            <h2>{% if is_control_system %}6{% else %}7{% endif %}. DW Gate</h2>
             <div class="section-content">
                 <div class="subsection">
                    <h3>DW Gate Dynamics</h3>
                    <div class="plot-container">
                        {% if plots.get('dw_distance_distribution') %}
                            <img src="data:image/png;base64,{{ plots.dw_distance_distribution }}" alt="DW Distance Distribution">
                            <p class="plot-caption">Distribution of DW gate distances</p>
                        {% else %}
                            <p class="unavailable"><i>DW gate distance distribution plot not available.</i></p>
                        {% endif %}
                    </div>
                    <div class="plot-container">
                        {% if plots.get('dw_distance_vs_state') %}
                            <img src="data:image/png;base64,{{ plots.dw_distance_vs_state }}" alt="DW Distance vs State">
                            <p class="plot-caption">DW gate distance versus state</p>
                        {% else %}
                            <p class="unavailable"><i>DW gate distance vs state plot not available.</i></p>
                        {% endif %}
                    </div>
                    <div class="plot-container">
                        {% if plots.get('dw_open_probability') %}
                            <img src="data:image/png;base64,{{ plots.dw_open_probability }}" alt="DW Open Probability">
                            <p class="plot-caption">DW gate open probability</p>
                        {% else %}
                            <p class="unavailable"><i>DW gate open probability plot not available.</i></p>
                        {% endif %}
                    </div>
                    <div class="plot-container">
                        {% if plots.get('dw_state_heatmap') %}
                            <img src="data:image/png;base64,{{ plots.dw_state_heatmap }}" alt="DW State Heatmap">
                            <p class="plot-caption">Heatmap of DW gate states</p>
                        {% else %}
                            <p class="unavailable"><i>DW gate state heatmap not available.</i></p>
                        {% endif %}
                    </div>
                     <div class="plot-container">
                        {% if plots.get('dw_duration_distributions') %}
                            <img src="data:image/png;base64,{{ plots.dw_duration_distributions }}" alt="DW Duration Distributions">
                            <p class="plot-caption">Distribution of DW gate state durations</p>
                        {% else %}
                            <p class="unavailable"><i>DW gate duration distribution plot not available.</i></p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="page-break" id="pocket">
            <h2>{% if is_control_system %}7{% else %}8{% endif %}. Pocket Waters</h2>
             <div class="section-content">
                 <div class="subsection">
                    <h3>Pocket Water Analysis</h3>
                    <div class="plot-container">
                        {% if plots.get('pocket_occupancy_plot') %} {# Correct key #}
                            <img src="data:image/png;base64,{{ plots.pocket_occupancy_plot }}" alt="Pocket Occupancy">
                            <p class="plot-caption">Occupancy of water molecules in peripheral pockets</p>
                        {% else %}
                            <p class="unavailable"><i>Pocket occupancy plot not available.</i></p>
                        {% endif %}
                    </div>
                    <div class="plot-container">
                        {% if plots.get('pocket_residence_histogram') %} {# Correct key #}
                            <img src="data:image/png;base64,{{ plots.pocket_residence_histogram }}" alt="Pocket Residence Distribution">
                            <p class="plot-caption">Cumulative distribution of water residence times in peripheral pockets</p>
                        {% else %}
                            <p class="unavailable"><i>Pocket residence distribution plot not available.</i></p>
                        {% endif %}
                    </div>
                     <div class="plot-container">
                        {% if plots.get('pocket_residence_analysis') %} {# Key for 2x2 plot #}
                            <img src="data:image/png;base64,{{ plots.pocket_residence_analysis }}" alt="Pocket Residence Analysis (2x2)">
                            <p class="plot-caption">Detailed analysis of water residence in peripheral pockets (2x2 Plot)</p>
                        {% else %}
                            <p class="unavailable"><i>Pocket residence comprehensive analysis plot not available.</i></p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            Generated by Pore Analysis Suite v{{ analysis_version }} | {{ generation_date }}
        </div>
    </div>
</body>
</html>
