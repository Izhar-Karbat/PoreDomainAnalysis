<div class="section">
    <h2>Run Information</h2>
    <table class="stats-table">
        <tr>
            <th>System</th>
            <td>{{ metadata.get('system_name', run_dir.split('/')[-3:] | join('/')) }}</td>
        </tr>
        <tr><th>Run</th><td>{{ run_name }}</td></tr>
        <tr><th>Path</th><td>{{ run_dir }}</td></tr>
        <tr><th>System Type</th><td>{% if is_control_system %}Control (No Toxin){% else %}Toxin-Channel Complex{% endif %}</td></tr>
        <tr><th>Analysis Status</th><td>{{ module_status.get('core_analysis', 'Unknown') }}</td></tr>
        <tr><th>Analysis Timestamp</th><td>{{ analysis_timestamp }}</td></tr>
    </table>
</div>

<div class="section">
    <h2>G-G Distance Analysis</h2>
    <table class="stats-table">
        <thead><tr><th>Metric</th><th>Filtered A:C</th><th>Filtered B:D</th></tr></thead>
        <tbody>
        <tr>
            <td>Mean (Å)</td>
            <td>{{ metrics.get('G_G_AC_Mean_Filt', {}).get('value', 'N/A')|round(3) if metrics.get('G_G_AC_Mean_Filt', {}).get('value') is not none else 'N/A' }}</td>
            <td>{{ metrics.get('G_G_BD_Mean_Filt', {}).get('value', 'N/A')|round(3) if metrics.get('G_G_BD_Mean_Filt', {}).get('value') is not none else 'N/A' }}</td>
        </tr>
        <tr>
            <td>Std Dev (Å)</td>
            <td>{{ metrics.get('G_G_AC_Std_Filt', {}).get('value', 'N/A')|round(3) if metrics.get('G_G_AC_Std_Filt', {}).get('value') is not none else 'N/A' }}</td>
            <td>{{ metrics.get('G_G_BD_Std_Filt', {}).get('value', 'N/A')|round(3) if metrics.get('G_G_BD_Std_Filt', {}).get('value') is not none else 'N/A' }}</td>
        </tr>
        <tr>
            <td>Min (Å)</td>
            <td>{{ metrics.get('G_G_AC_Min_Filt', {}).get('value', 'N/A')|round(3) if metrics.get('G_G_AC_Min_Filt', {}).get('value') is not none else 'N/A' }}</td>
            <td>{{ metrics.get('G_G_BD_Min_Filt', {}).get('value', 'N/A')|round(3) if metrics.get('G_G_BD_Min_Filt', {}).get('value') is not none else 'N/A' }}</td>
        </tr>
        <tr>
            <td>Max (Å)</td>
            <td>{{ metrics.get('G_G_AC_Max_Filt', {}).get('value', 'N/A')|round(3) if metrics.get('G_G_AC_Max_Filt', {}).get('value') is not none else 'N/A' }}</td>
            <td>{{ metrics.get('G_G_BD_Max_Filt', {}).get('value', 'N/A')|round(3) if metrics.get('G_G_BD_Max_Filt', {}).get('value') is not none else 'N/A' }}</td>
        </tr>
        </tbody>
    </table>
    <div class="plot-container">
        <div style="display: flex; justify-content: space-around; margin-bottom: 5px; font-weight: bold; font-size: 0.9em;">
            <div style="flex-basis: 50%; text-align: center;">Chains A:C</div>
            <div style="flex-basis: 50%; text-align: center;">Chains B:D</div>
        </div>
        {% if plots.get('subunit_comparison') %}
            <img src="data:image/png;base64,{{ plots.subunit_comparison }}" alt="G-G Distance Subunit Comparison (Raw vs Filtered)">
        {% else %}
            <p><i>G-G distance comparison plot not available.</i></p>
        {% endif %}
    </div>
</div>

{% if not is_control_system %}
<div class="section">
    <h2>COM Distance Analysis (Toxin-Channel Stability)</h2>
    <table class="stats-table">
        <thead><tr><th>Metric</th><th>Filtered COM</th></tr></thead>
        <tbody>
        <tr>
            <td>Mean (Å)</td>
            <td>{{ metrics.get('COM_Mean_Filt', {}).get('value', 'N/A')|round(3) if metrics.get('COM_Mean_Filt', {}).get('value') is not none else 'N/A' }}</td>
        </tr>
        <tr>
            <td>Std Dev (Å)</td>
            <td>{{ metrics.get('COM_Std_Filt', {}).get('value', 'N/A')|round(3) if metrics.get('COM_Std_Filt', {}).get('value') is not none else 'N/A' }}</td>
        </tr>
        <tr>
            <td>Min (Å)</td>
            <td>{{ metrics.get('COM_Min_Filt', {}).get('value', 'N/A')|round(3) if metrics.get('COM_Min_Filt', {}).get('value') is not none else 'N/A' }}</td>
        </tr>
        <tr>
            <td>Max (Å)</td>
            <td>{{ metrics.get('COM_Max_Filt', {}).get('value', 'N/A')|round(3) if metrics.get('COM_Max_Filt', {}).get('value') is not none else 'N/A' }}</td>
        </tr>
        </tbody>
    </table>

    <div class="two-column">
        <div class="column plot-container">
             <h3>channel:toxin COM distance</h3> {% if plots.get('comparison') %} <img src="data:image/png;base64,{{ plots.comparison }}" alt="COM Distance Filtering Comparison">
             {% else %}
                 <p><i>Plot not available.</i></p>
             {% endif %}
         </div>

        <div class="column plot-container">
            <h3>COM KDE Analysis</h3>
            {% if plots.get('com_kde') %} <img src="data:image/png;base64,{{ plots.com_kde }}" alt="COM KDE Analysis">
            {% else %}
                <p><i>Plot not available.</i></p>
            {% endif %}
        </div>
    </div> </div>
{% else %}
<div class="section">
    <h2>COM Distance Analysis</h2>
    <div class="info-box">
        This is a control system without toxin. COM distance analysis is not applicable.
    </div>
</div>
{% endif %}
