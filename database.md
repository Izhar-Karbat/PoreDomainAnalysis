# Pore Analysis Suite Database (`analysis_registry.db`)

This document describes the schema and contents of the SQLite database (`analysis_registry.db`) used by the Pore Analysis Suite. This database is created within each simulation run's directory to track the analysis workflow, generated products, and key results.

This file also serves as an **index** to the typical data products and metrics generated by the analysis modules. Developers can refer to the sections below to locate specific outputs.

**Schema Version:** 1.0.0

## Purpose

The database serves several key purposes:
1.  **Workflow Tracking:** Records which analysis modules have been run and their status (pending, running, success, failed).
2.  **Product Registry:** Provides a central catalog of all output files (CSVs, PNGs, JSON, etc.) generated by the analysis, linking them to the module that created them.
3.  **Metric Storage:** Stores key numerical results (metrics) from the analysis in a queryable format, facilitating comparison across runs.
4.  **Metadata Storage:** Holds essential metadata about the simulation run and the analysis process itself.
5.  **Reproducibility & Debugging:** Helps understand what was run, what was produced, and identify potential issues or points for re-analysis.

## Tables Schema

### 1. `simulation_metadata`

Stores key-value pairs relating to the overall simulation run and analysis execution.

| Column        | Type    | Description                                                                 |
| :------------ | :------ | :-------------------------------------------------------------------------- |
| `metadata_id` | INTEGER | Primary Key                                                                 |
| `key`         | TEXT    | Unique key identifying the metadata item (UNIQUE, NOT NULL)                 |
| `value`       | TEXT    | Value associated with the key (stored as text)                              |

**(See "Index of Common Metadata Keys" below for typical keys)**

### 2. `analysis_modules`

Tracks the execution status and details of individual analysis modules (or sub-modules).

| Column            | Type    | Description                                                                 |
| :---------------- | :------ | :-------------------------------------------------------------------------- |
| `module_id`       | INTEGER | Primary Key                                                                 |
| `module_name`     | TEXT    | Unique name identifying the module (UNIQUE, NOT NULL)                       |
| `status`          | TEXT    | Execution status (e.g., `pending`, `running`, `success`, `failed`, `skipped`) |
| `execution_time`  | REAL    | Execution time in seconds (if completed)                                    |
| `start_timestamp` | TEXT    | ISO timestamp when the module started running                               |
| `end_timestamp`   | TEXT    | ISO timestamp when the module finished (success or failed)                  |
| `parameters`      | TEXT    | JSON string containing parameters used by the module (optional)             |
| `error_message`   | TEXT    | Error message if the module failed (optional)                               |

**(See "Index of Analysis Modules" below for typical module names)**

### 3. `analysis_products`

Registry of all files generated by the analysis modules. The combination of `category`, `subcategory`, and `module_name` is typically used to retrieve specific products.

| Column                 | Type    | Description                                                                      |
| :--------------------- | :------ | :------------------------------------------------------------------------------- |
| `product_id`           | INTEGER | Primary Key                                                                      |
| `module_id`            | INTEGER | Foreign Key referencing `analysis_modules` (NOT NULL)                            |
| `product_type`         | TEXT    | File extension or type (e.g., `csv`, `png`, `json`, `txt`) (NOT NULL)            |
| `category`             | TEXT    | Broad category (e.g., `data`, `plot`, `summary`, `definition`) (NOT NULL)      |
| `subcategory`          | TEXT    | **Key specific identifier** for the product within its category                  |
| `relative_path`        | TEXT    | Path relative to the `run_dir` (UNIQUE, NOT NULL)                                |
| `description`          | TEXT    | Brief description of the product (optional)                                      |
| `generation_timestamp` | TEXT    | ISO timestamp when the product was generated/registered                          |
| `metadata`             | TEXT    | Additional JSON metadata about the product (optional)                            |

**(See "Index of Analysis Products" below for typical products generated by each module)**

### 4. `metrics`

Stores specific numerical results (metrics) calculated by analysis modules. The `metric_name` is the key identifier.

| Column        | Type    | Description                                                                  |
| :------------ | :------ | :--------------------------------------------------------------------------- |
| `metric_id`   | INTEGER | Primary Key                                                                  |
| `module_id`   | INTEGER | Foreign Key referencing `analysis_modules` (NOT NULL)                        |
| `metric_name` | TEXT    | **Key identifier** for the metric (UNIQUE per module, NOT NULL)              |
| `value`       | REAL    | Numerical value of the metric (can be NULL for NaN/Inf)                      |
| `units`       | TEXT    | Units of the metric value (e.g., `Å`, `ns`, `°`, `count`, `%`) (optional)    |
| `description` | TEXT    | Brief description of the metric (optional)                                   |

**(See "Index of Metrics" below for typical metrics generated by each module)**

### 5. `dependencies` (Future Use)

Intended to formally track dependencies between analysis modules.

| Column                | Type    | Description                                       |
| :-------------------- | :------ | :------------------------------------------------ |
| `dependency_id`       | INTEGER | Primary Key                                       |
| `dependent_module_id` | INTEGER | Foreign Key to `analysis_modules` (the module that *needs* the dependency) |
| `required_module_id`  | INTEGER | Foreign Key to `analysis_modules` (the module that *provides* the dependency) |

### 6. `product_relationships` (Future Use)

Intended to track relationships between analysis products (e.g., a plot derived from a CSV).

| Column             | Type    | Description                                          |
| :----------------- | :------ | :--------------------------------------------------- |
| `relationship_id`  | INTEGER | Primary Key                                          |
| `source_product_id`| INTEGER | Foreign Key to `analysis_products` (the input product) |
| `derived_product_id`| INTEGER | Foreign Key to `analysis_products` (the output product)|
| `relationship_type`| TEXT    | Type of relationship (e.g., `visualization_of`)      |

---

## Index of Database Contents

### Index of Common Metadata Keys (`simulation_metadata` table)

* `schema_version`: Version of the database schema (e.g., `1.0.0`).
* `db_init_timestamp`: ISO timestamp when the database was initialized.
* `run_name`: Name of the simulation run directory (e.g., `R6`).
* `system_name`: Name of the system directory (parent of run_name) (e.g., `toxin`).
* `analysis_start_time`: ISO timestamp when the `main.py` script started.
* `analysis_end_time`: ISO timestamp when the `main.py` script finished.
* `analysis_status`: Overall status of the analysis run (`success`, `failed`).
* `psf_file`: Basename of the PSF file used (e.g., `step5_input.psf`).
* `dcd_file`: Basename of the DCD file used (e.g., `MD_Aligned.dcd`).
* `analysis_version`: Version of the Pore Analysis Suite used (e.g., `2.0.0`).
* `is_control_system`: Boolean (`'True'`/`'False'`) indicating if toxin is absent.
* `filter_residues_dict`: JSON string representation of the filter residue dictionary (`{'PROA': [63, 64, 65, 66, 67], ...}`).

### Index of Analysis Modules (`analysis_modules` table)

* `core_analysis`: Raw trajectory reading (G-G, COM distances).
* `core_analysis_filtering`: Filtering of core distance data.
* `core_analysis_visualization_g_g`: Plotting for G-G distances.
* `core_analysis_visualization_com`: Plotting for COM distance/KDE.
* `orientation_analysis`: Toxin orientation/contact computation.
* `orientation_analysis_visualization`: Toxin orientation/contact plotting.
* `ion_analysis`: Ion analysis computation (tracking, sites, occupancy, HMM).
* `ion_analysis_visualization`: Ion analysis plotting.
* `inner_vestibule_analysis`: Inner vestibule water computation.
* `inner_vestibule_analysis_visualization`: Inner vestibule water plotting.
* `pocket_analysis`: Peripheral pocket water analysis computation (ML-based).
* `pocket_analysis_visualization`: Peripheral pocket water analysis plotting.
* `report_generation`: HTML report generation process.
* *(Future modules: gyration, tyrosine, dwgates...)*

### Index of Analysis Products (`analysis_products` table)

This section lists typical files generated, identified by their `subcategory`.

**Module: `core_analysis`**
* Category: `data`, Subcategory: `raw_distances`, Type: `csv`, Path: `core_analysis/Raw_Distances.csv` (Raw G-G and COM distances per frame)

**Module: `core_analysis_filtering`**
* Category: `data`, Subcategory: `g_g_distance_filtered`, Type: `csv`, Path: `core_analysis/G_G_Distance_Filtered.csv` (Raw and filtered G-G data)
* Category: `data`, Subcategory: `com_stability_filtered`, Type: `csv`, Path: `core_analysis/COM_Stability_Filtered.csv` (Raw and filtered COM data)

**Module: `core_analysis_visualization_g_g`**
* Category: `plot`, Subcategory: `subunit_comparison`, Type: `png`, Path: `core_analysis/G_G_Distance_Subunit_Comparison.png` (Side-by-side raw vs filtered G-G plots for AC/BD pairs)

**Module: `core_analysis_visualization_com`**
* Category: `plot`, Subcategory: `comparison`, Type: `png`, Path: `core_analysis/COM_Stability_Comparison.png` (Raw vs filtered COM distance plot)
* Category: `plot`, Subcategory: `kde_analysis`, Type: `png`, Path: `core_analysis/COM_Stability_KDE_Analysis.png` (KDE distribution of COM distance)

**Module: `orientation_analysis`**
* Category: `data`, Subcategory: `orientation_timeseries`, Type: `csv`, Path: `orientation_contacts/orientation_data.csv` (Time series of orientation angle, rotation, atom contacts)
* Category: `data`, Subcategory: `residue_frequency`, Type: `csv`, Path: `orientation_contacts/residue_contact_frequency.csv` (Average residue contact frequency map)

**Module: `orientation_analysis_visualization`**
* Category: `plot`, Subcategory: `orientation_angle`, Type: `png`, Path: `orientation_contacts/Toxin_Orientation_Angle.png`
* Category: `plot`, Subcategory: `rotation_components`, Type: `png`, Path: `orientation_contacts/Toxin_Rotation_Components.png`
* Category: `plot`, Subcategory: `channel_contacts`, Type: `png`, Path: `orientation_contacts/Toxin_Channel_Contacts.png`
* Category: `plot`, Subcategory: `contact_map_focused`, Type: `png`, Path: `orientation_contacts/Toxin_Channel_Residue_Contact_Map_Focused.png`
* *Note: Full contact map PNG generation is currently commented out.*

**Module: `ion_analysis`** (Computation generates definitions, data, plots)
* Category: `data`, Subcategory: `ion_positions_g1_centric`, Type: `csv`, Path: `ion_analysis/ion_positions_g1_centric.csv`
* Category: `data`, Subcategory: `ion_positions_absolute`, Type: `csv`, Path: `ion_analysis/ion_positions_absolute.csv`
* Category: `data`, Subcategory: `ion_filter_presence`, Type: `csv`, Path: `ion_analysis/ion_filter_presence.csv`
* Category: `definition`, Subcategory: `binding_sites_definition`, Type: `txt`, Path: `ion_analysis/binding_site_positions_g1_centric.txt` (Optimized site definitions relative to G1)
* Category: `plot`, Subcategory: `site_optimization_plot`, Type: `png`, Path: `ion_analysis/binding_site_optimization.png` (Generated during site calculation)
* Category: `data`, Subcategory: `ion_occupancy_per_frame`, Type: `csv`, Path: `ion_analysis/ion_occupancy_per_frame.csv`
* Category: `data`, Subcategory: `ion_site_statistics`, Type: `csv`, Path: `ion_analysis/ion_site_statistics.csv`
* Category: `data`, Subcategory: `ion_hmm_dwell_events`, Type: `csv`, Path: `ion_analysis/ion_hmm_dwell_events.csv`
* Category: `data`, Subcategory: `ion_hmm_quality_data`, Type: `csv`, Path: `ion_analysis/ion_hmm_quality_data.csv`
* Category: `data`, Subcategory: `ion_hmm_conduction_events`, Type: `csv`, Path: `ion_analysis/ion_hmm_conduction_events.csv`

**Module: `ion_analysis_visualization`**
* Category: `plot`, Subcategory: `binding_sites_visualization`, Type: `png`, Path: `ion_analysis/binding_sites_g1_centric_visualization.png`
* Category: `plot`, Subcategory: `combined_plot`, Type: `png`, Path: `ion_analysis/K_Ion_Combined_Plot.png` (Ion Z-positions vs Time & Density)
* Category: `plot`, Subcategory: `occupancy_heatmap`, Type: `png`, Path: `ion_analysis/K_Ion_Occupancy_Heatmap.png`
* Category: `plot`, Subcategory: `average_occupancy`, Type: `png`, Path: `ion_analysis/K_Ion_Average_Occupancy.png`
* Category: `plot`, Subcategory: `hmm_transitions_plot`, Type: `png`, Path: `ion_analysis/ion_transitions_hmm.png`
* Category: `plot`, Subcategory: `quality_metrics_plot`, Type: `png`, Path: `ion_analysis/ion_quality_metrics.png`

**Module: `inner_vestibule_analysis`**
* Category: `data`, Subcategory: `occupancy_per_frame`, Type: `csv`, Path: `inner_vestibule_analysis/inner_vestibule_occupancy.csv`
* Category: `data`, Subcategory: `residence_times`, Type: `json`, Path: `inner_vestibule_analysis/inner_vestibule_residence_times.json`

**Module: `inner_vestibule_analysis_visualization`**
* Category: `plot`, Subcategory: `count_plot`, Type: `png`, Path: `inner_vestibule_analysis/inner_vestibule_count_plot.png`
* Category: `plot`, Subcategory: `residence_hist`, Type: `png`, Path: `inner_vestibule_analysis/inner_vestibule_residence_hist.png`

**Module: `pocket_analysis`**
* Category: `data`, Subcategory: `pocket_occupancy_timeseries`, Type: `csv`, Path: `pocket_analysis/pocket_occupancy.csv`
* Category: `data`, Subcategory: `pocket_residence_stats`, Type: `json`, Path: `pocket_analysis/pocket_residence_stats.json`
* Category: `data`, Subcategory: `pocket_assignments_per_frame`, Type: `pkl`, Path: `pocket_analysis/pocket_assignments.pkl`
* Category: `data`, Subcategory: `pocket_imbalance_metrics`, Type: `csv`, Path: `pocket_analysis/pocket_imbalance_metrics.csv`
* Category: `summary`, Subcategory: `pocket_analysis_summary`, Type: `txt`, Path: `pocket_analysis/pocket_summary.txt`

**Module: `pocket_analysis_visualization`**
* Category: `plot`, Subcategory: `pocket_occupancy_plot`, Type: `png`, Path: `pocket_analysis/pocket_occupancy_plot.png`
* Category: `plot`, Subcategory: `pocket_residence_histogram`, Type: `png`, Path: `pocket_analysis/pocket_residence_distribution.png`

**Module: `summary`**
* Category: `summary`, Subcategory: `analysis_summary`, Type: `json`, Path: `analysis_summary.json`

**Module: `report_generation`**
* Category: `report`, Subcategory: `analysis_report`, Type: `html`, Path: `data_analysis_report.html`

### Index of Metrics (`metrics` table)

This section lists typical metrics stored, identified by `metric_name`.

**Module: `core_analysis_filtering`**
* `COM_Max_Filt`: (Units: Å) Max filtered COM distance.
* `COM_Mean_Filt`: (Units: Å) Mean filtered COM distance.
* `COM_Min_Filt`: (Units: Å) Min filtered COM distance.
* `COM_Std_Filt`: (Units: Å) Std Dev filtered COM distance.
* `G_G_AC_Max_Filt`: (Units: Å) Max filtered A-C G-G distance.
* `G_G_AC_Mean_Filt`: (Units: Å) Mean filtered A-C G-G distance.
* `G_G_AC_Min_Filt`: (Units: Å) Min filtered A-C G-G distance.
* `G_G_AC_Std_Filt`: (Units: Å) Std Dev filtered A-C G-G distance.
* `G_G_BD_Max_Filt`: (Units: Å) Max filtered B-D G-G distance.
* `G_G_BD_Mean_Filt`: (Units: Å) Mean filtered B-D G-G distance.
* `G_G_BD_Min_Filt`: (Units: Å) Min filtered B-D G-G distance.
* `G_G_BD_Std_Filt`: (Units: Å) Std Dev filtered B-D G-G distance.

**Module: `orientation_analysis`**
* `Orient_Angle_Mean`: (Units: °) Mean Toxin-Channel Orientation Angle.
* `Orient_Angle_Std`: (Units: °) Std Dev Toxin-Channel Orientation Angle.
* `Orient_Contacts_Mean`: (Units: count) Mean Atom Contacts (<3.5Å).
* `Orient_Contacts_Std`: (Units: count) Std Dev Atom Contacts (<3.5Å).
* `Orient_RotX_Mean`: (Units: °) Mean Toxin Rotation (X).
* `Orient_RotX_Std`: (Units: °) Std Dev Toxin Rotation (X).
* `Orient_RotY_Mean`: (Units: °) Mean Toxin Rotation (Y).
* `Orient_RotY_Std`: (Units: °) Std Dev Toxin Rotation (Y).
* `Orient_RotZ_Mean`: (Units: °) Mean Toxin Rotation (Z).
* `Orient_RotZ_Std`: (Units: °) Std Dev Toxin Rotation (Z).

**Module: `ion_analysis`** (Occupancy and HMM Stats)
* `Ion_AvgOcc_{Site}`: (Units: count) Mean occupancy of site {Site} (e.g., `Ion_AvgOcc_S2`).
* `Ion_MaxOcc_{Site}`: (Units: count) Max occupancy of site {Site} (e.g., `Ion_MaxOcc_S4`).
* `Ion_PctTimeOcc_{Site}`: (Units: %) % Time site {Site} has >0 ions (e.g., `Ion_PctTimeOcc_S0`).
* `Ion_HMM_TransitionEvents_Total`: (Units: count) Total adjacent site transition events (HMM).
* `Ion_HMM_TransitionEvents_Upward`: (Units: count) Upward transition events (HMM).
* `Ion_HMM_TransitionEvents_Downward`: (Units: count) Downward transition events (HMM).
* `Ion_HMM_Transition_{S1}_{S2}`: (Units: count) Transitions between {S1} and {S2} (HMM) (e.g., `Ion_HMM_Transition_S3_S2`).
* `Ion_HMM_ConductionEvents_Total`: (Units: count) Total full conduction events (HMM).
* `Ion_HMM_ConductionEvents_Outward`: (Units: count) Outward conduction events (HMM).
* `Ion_HMM_ConductionEvents_Inward`: (Units: count) Inward conduction events (HMM).
* `Ion_HMM_Conduction_MeanTransitTime_ns`: (Units: ns) Mean full transit time (HMM).
* `Ion_HMM_Conduction_MedianTransitTime_ns`: (Units: ns) Median full transit time (HMM).
* `Ion_HMM_Conduction_StdTransitTime_ns`: (Units: ns) Std Dev full transit time (HMM).

**Module: `inner_vestibule_analysis`**
* `InnerVestibule_AvgResidenceTime_ns`: (Units: ns) Mean residence time of water in vestibule.
* `InnerVestibule_ExchangeRatePerNs`: (Units: rate (ns^-1)) Rate of confirmed water exit events per ns.
* `InnerVestibule_MeanOcc`: (Units: count) Mean number of water molecules in vestibule.
* `InnerVestibule_MedianResidenceTime_ns`: (Units: ns) Median residence time of water in vestibule.
* `InnerVestibule_StdOcc`: (Units: count) Std Dev number of water molecules in vestibule.
* `InnerVestibule_TotalExitEvents`: (Units: count) Total confirmed water exit events.

**Module: `pocket_analysis`**
* `Pocket{A/B/C/D}_MeanOccupancy`: (Units: count) Mean water occupancy in Pocket {A/B/C/D}.
* `Pocket{A/B/C/D}_OccupancyStd`: (Units: count) Std Dev of water occupancy in Pocket {A/B/C/D}.
* `Pocket{A/B/C/D}_MeanResidence_ns`: (Units: ns) Mean residence time in Pocket {A/B/C/D}.
* `Pocket{A/B/C/D}_MedianResidence_ns`: (Units: ns) Median residence time in Pocket {A/B/C/D}.
* `Pocket{A/B/C/D}_MaxResidence_ns`: (Units: ns) Max residence time in Pocket {A/B/C/D}.
* `Pocket{A/B/C/D}_ResidencePeriods`: (Units: count) Number of residence periods >= threshold in Pocket {A/B/C/D}.
* `Pocket{A/B/C/D}_RTSkewness`: (Units: ) Skewness of residence time distribution for Pocket {A/B/C/D}.
* `Pocket{A/B/C/D}_ShortLivedPct`: (Units: %) Percentage of residence times < ShortLivedThreshold in Pocket {A/B/C/D}.
* `Pocket{A/B/C/D}_LongLivedPct`: (Units: %) Percentage of residence times > LongLivedThreshold in Pocket {A/B/C/D}.
* `PocketWater_OccupancyRatio`: (Units: ) Ratio of Max Mean Occupancy / Min Mean Occupancy across pockets.
* `PocketWater_KS_{P1}_{P2}`: (Units: KS stat) Kolmogorov-Smirnov statistic comparing RT distributions between Pocket {P1} and {P2} (e.g., `PocketWater_KS_A_B`).
* `CV_of_Mean_Residence_Times`: (Units: ) Coefficient of Variation of mean residence times across pockets.
* `Gini_Coefficient_TotalTime`: (Units: ) Gini coefficient based on total residence time per pocket.
* `Entropy_TotalTime`: (Units: ) Entropy based on total residence time per pocket.
* `Max_Pairwise_KS_Statistic`: (Units: KS stat) Maximum KS statistic found between any pair of pockets.
* `Normalized_Range_Median_RTs`: (Units: ) Normalized range of median residence times across pockets.
* `ANOVA_inspired_F_statistic`: (Units: ) Ratio of between-pocket to within-pocket variance in residence times. (Note: Interpretation needs care).
* `Multivariate_Dispersion_Index`: (Units: ) Average distance from centroid based on normalized residence times. (Note: Interpretation needs care).

---